# 	$id
# 	$repository
# 	$method
# 	$release_name
#	$release_path
#	$shared_path
#	${!branch}
#   ${!deploy_to}
#	${hosts[@]}
#	${tasks[@]}

# Abort on error is deffered to trap ERR caught

track "screen" "$green$counter) Project $id$std"

copy_path=$copy_dir"/"$release_name"/"${!branch}

if [ ! -f "$copy_path/$release_name.tgz" ] ; 
then
	exec_wrap "$id:clone" $method "-b ${!branch} --single-branch" $repository $copy_path"/"$release_name
	exec_wrap "$id:clone:clean" rm -rf $copy_path"/"$release_name"/".git
	exec_wrap "$id:compress" tar -zcf $copy_path/$release_name.tgz -C $copy_path"/" $release_name
fi

for hostid in "${hosts[@]}"
do
	host="hosts_"$hostid"_host"
	user="hosts_"$hostid"_user"
	port="hosts_"$hostid"_port"
	if [ -z "${!port}" ]; then ssh_target="${!user}@${!host}"; else ssh_target="-p ${!port} ${!user}@${!host}"; fi

	track "screen" "Working on host $green"${!host}"$std"

	. $abs_path/lib/replace_vars

	# Get previous release path
	replace_vars $abs_path"/tasks-native/previous-release"
	retvalue=`ssh $ssh_target $commmand`
	if [ $retvalue != "" ]; then eval $retvalue; fi;

	last_ssh_target=$ssh_target
	if [ -z "${!port}" ]; 
		then 
		exec_wrap "$id:scp" scp $copy_path/$release_name.tgz $ssh_target:/tmp/; 
	else
		exec_wrap "$id:scp" scp -P ${!port} $copy_path/$release_name.tgz ${!user}@${!host}:/tmp/; 
	fi;
	
	exec_wrap "$id:remote:mvtarball" ssh $ssh_target mv /tmp/$release_name.tgz ${!deploy_to}/releases/
	exec_wrap "$id:remote:untar" ssh $ssh_target tar -zxf ${!deploy_to}/releases/$release_name.tgz -C ${!deploy_to}/releases/
	exec_wrap "$id:remote:deletetarball" ssh $ssh_target rm -f ${!deploy_to}/releases/$release_name.tgz

	for task in "${tasks[@]}"
	do
		if [[ $task == "tasks-common"* ]] ; 
			then 
			 replace_vars $abs_path"/"$task
			 exec_wrap "$id:remote:task:$task" ssh $ssh_target $commmand
			else
			 replace_vars $task
			 exec_wrap "$id:remote:task:$task" ssh $ssh_target $commmand
		fi
	done

	# publish : change current target to this fresh release
	replace_vars $abs_path"/tasks-native/current-new-release"
	exec_bloc_wrap "$id:remote:task:publish" ssh $ssh_target "$commmand"

	# keep_releases : delete too old releases
	replace_vars $abs_path"/tasks-native/keep-releases"
	exec_bloc_wrap "$id:remote:task:keep_releases" ssh $ssh_target "$commmand"

done
